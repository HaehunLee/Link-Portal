<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="kr.co.link.dao.JisikinDao">		<!-- Dao경로설정 -->

	<insert id="addJisikin" parameterType="jisikin">
		insert into Jisikin (jisikin_no, 
							 jisikin_title, 
							 jisikin_content,
							 jisikin_secret_yn, 
							 jisikin_mental_point, 
                             user_id,
							 category_no)
		values
		(#{no}, #{title},#{contents},#{secretYn},#{mentalPoint},#{userId},#{category.no})
	</insert>
	
	<select id="getJisikinSeq" resultType="Integer">
		select	jisikin_seq.nextval
		from	dual
	</select>
	
	<select id="getJisikinByNo" parameterType="int" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint, 
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate,
			user_id userId,
			jisikin_recommend recommend,
			(select count(answer_no) from jisikin_answer where jisikin_answer.jisikin_no = jisikin.jisikin_no) countAnswer
		from
			jisikin, jisikin_category
		where
			jisikin.category_no = jisikin_category.category_no
		and
			jisikin.jisikin_no = #{value}
		order by
			jisikin_create_date desc
	</select>
	
	<select id="getAllJisikin" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint, 
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate,
			user_id userId,
			(select count(answer_no) from jisikin_answer where jisikin_answer.jisikin_no = jisikin.jisikin_no) countAnswer
		from
			jisikin, jisikin_category
		where
			jisikin.category_no = jisikin_category.category_no
		order by
			jisikin_create_date desc
	</select>
	
	<select id="getJisikinByCategory" parameterType="int" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint, 
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate
		from
			jisikin, jisikin_category
		where
			jisikin.category_no = jisikin_category.category_no
		and
			jisikin_category.category_parent_no = #{value}
		order by
			jisikin_create_date desc
	</select>
	
	<select id="countTodayJisikin" resultType="Integer">
		select 
			count(*)
		from 
			jisikin
		where 
		    to_char(jisikin_create_date, 'yy/mm/dd') = (select to_char(sysdate, 'yy/mm/dd') from dual)
	</select>
	
	
	<!-- 카테고리별 키워드 검색 -->
	<select id="searchJisikinsByCategory" parameterType="map" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint, 
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate
		from
			jisikin, jisikin_category
		where
            jisikin.category_no = jisikin_category.category_no
        and
			jisikin_category.category_parent_no = #{no}
		and
			(jisikin.jisikin_title like '%' || #{keyword} || '%' or jisikin.jisikin_content like '%' || #{keyword} || '%')
			
	</select>
	
	
	<!-- 추천 -->
	<update id="updateJisikinByNo" parameterType="jisikin">
		update 
			jisikin
		set 
		    jisikin_recommend = #{recommend}
		where
		    jisikin_no = #{no}
	</update>
	
	<select id="getJisikinByrecommend" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint, 
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate,
			user_id userId,
			jisikin_recommend recommend,
			(select count(answer_no) from jisikin_answer where jisikin_answer.jisikin_no = jisikin.jisikin_no) countAnswer
		from
			jisikin, jisikin_category
		where
			jisikin.category_no = jisikin_category.category_no
		order by
			jisikin_recommend desc
		
	</select>
	
	<!-- 나의 질문, 나의 답변 -->
	<select id="getMyJisikin" parameterType="string" resultType="jisikin">
		select
			jisikin_no no, 
			jisikin_title title, 
			jisikin_content contents,
			jisikin_secret_yn secretYn, 
			jisikin_mental_point mentalPoint,
			jisikin_deadline_yn deadLineYn,
			jisikin.category_no "category.no",
			category_name "category.name",
			jisikin_create_date createDate,
			user_id userId,
			jisikin_recommend recommend,
			(select count(answer_no) from jisikin_answer where jisikin_answer.jisikin_no = jisikin.jisikin_no) countAnswer
		from
			jisikin, jisikin_category
		where
			jisikin.category_no = jisikin_category.category_no
		and
			jisikin.user_id = #{value}
		order by
			jisikin_create_date desc
	</select>
	
	
	
	<select id="getMyAnswer" parameterType="string" resultType="jisikinAnswer">
		select
			answer_no no,
			answer_create_date createDate,
			answer_selected_yn selectedYn,
			answer_secret_yn secretYn,
			jisikin_no jisikinNo,
			user_id userId,
			answer_contents contents
		from
			jisikin_answer
		where
			jisikin_answer.user_id = #{value}
		order by
			answer_create_date desc	
	</select>
</mapper>