<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

  <mapper namespace="kr.co.link.dao.AccountBookDao"> <!-- Dao 경로 설정 -->
  
    <!-- 태그 추가 -->
  	<insert id="addTag" parameterType="accountBookTag">
  		insert into accountbook_tag(tag_no,tag_name,term_no)
  		values(accountbook_tag_seq.nextval,#{tagName},#{termNo})
  	</insert>

  	<!--지출 수입 내역 추가 -->
  	<insert id="addexpense" parameterType="accountBookTerm">
		INSERT INTO ACCOUNTBOOK_TERM(		
			TERM_CASH,
			TERM_CARD,
			TERM_NO,
			TERM_DETAIL,
			TERM_DATE,
			TERM_REMAIN_AMOUNT,
			TERM_MEMO,
			CATEGORY_NO,
			USER_ID,
			TERM_GUBUN,
			TERM_CREATE_DATE)
		VALUES 
				(#{cash},#{card},#{no},#{detail},#{date},0,#{memo},#{category.categoryNo},#{id},#{gubun},sysdate)
	  	
  	</insert>
  	
  	<!-- 수입 내역 추가 -->
  	<insert id="addIncome" parameterType="accountBookTerm">
		INSERT INTO ACCOUNTBOOK_TERM(		
			TERM_CASH,
			TERM_NO,
			TERM_DETAIL,
			TERM_DATE,
			TERM_REMAIN_AMOUNT,
			TERM_MEMO,
			CATEGORY_NO,
			USER_ID,
			TERM_GUBUN,
			TERM_CREATE_DATE)
		VALUES 
				(#{cash},#{no},#{detail},#{date},0,#{memo},#{category.categoryNo},#{id},#{gubun},sysdate)
	  	
  	</insert>
  	
  	<select id="getTermNoSeq" resultType="int">
  		select EXPENSE_NO_SEQ.nextval from dual
  	</select>
  	
  	
  	
  	<!-- 지출 내역 조회 -->
  	<select id="getExpenseByuserId" parameterType="string" resultType="accountBookTerm">
		 SELECT 
		 			nvl(A.TERM_CARD, 0)		card,
  					nvl(A.TERM_CASH, 0)		cash, 
  					A.TERM_NO				no, 
  					A.TERM_DETAIL			detail, 
  					A.TERM_DATE				"date", 
  					A.TERM_REMAIN_AMOUNT	remainAmount, 
  					A.TERM_MEMO				memo, 
  					A.TERM_GUBUN			gubun, 
  					A.TERM_CREATE_DATE		createDate, 
  					B.TAG_NAME				"tag.tagName",
  					C.CATEGORY_NO			"category.categoryNo",
  					C.CATEGORY_NAME			"category.categoryName"
		FROM 
					ACCOUNTBOOK_TERM A, ACCOUNTBOOK_TAG B, ACCOUNTBOOK_CATEGORY C
		WHERE 
					A.USER_ID=#{value}
		AND
					A.TERM_GUBUN='지출'
		AND
					A.CATEGORY_NO=C.CATEGORY_NO
		AND 		
					A.TERM_NO = B.TERM_NO
  	</select>
  	
  	<!-- 수입내역조회 -->
  	<select id="getIncomeByuserId" parameterType="string" resultType="accountBookTerm">
  		SELECT 
  					nvl(A.TERM_CASH,0)		cash, 
  					nvl(A.TERM_NO,0)		no, 
  					A.TERM_DETAIL			detail, 
  					A.TERM_DATE				"date", 
  					A.TERM_REMAIN_AMOUNT	remainAmount, 
  					A.TERM_MEMO				memo, 
  					A.TERM_GUBUN			gubun, 
  					A.TERM_CREATE_DATE		createDate, 
  					B.TAG_NAME				"tag.tagName",
  					C.CATEGORY_NO			"category.categoryNo",
  					C.CATEGORY_NAME			"category.categoryName"
		FROM 
					ACCOUNTBOOK_TERM A, ACCOUNTBOOK_TAG B, ACCOUNTBOOK_CATEGORY C
		WHERE 
					A.USER_ID=#{value}
		AND
					A.TERM_GUBUN='수입'
		AND
					A.CATEGORY_NO=C.CATEGORY_NO
		AND 		
					A.TERM_NO = B.TERM_NO 
  	</select>
  	
  	<!-- 지출 카테고리 조회-->
  	<select id="getExpenseCategory" resultType="accountBookCategory" >
  		SELECT 
  				CATEGORY_NO categoryNo, 
  				CATEGORY_NAME categoryName
		FROM 
				ACCOUNTBOOK_CATEGORY
		where 
				CATEGORY_GUBUN='지출'	
  	</select>
  	
  	<!-- 수입 카테고리 조회 -->
 	<select id="getIncomeCategory" resultType="accountBookCategory">
 		SELECT 
  				CATEGORY_NO categoryNo, 
  				CATEGORY_NAME categoryName
		FROM 
				ACCOUNTBOOK_CATEGORY
		where 
				CATEGORY_GUBUN='수입'	
 	</select>
 	
 	<!--
 		 카테고리별 지출 금액 
 		 :카테고리 번호를 이용하여  카테고리 종류별로 카테고리 이름과 토탈비용 조회
 	-->
		 	
		<select id="getCategoryAndExpenseByCategoryNo" parameterType="string" resultType="hashmap">
			SELECT 
			 		B.category_name, nvl(total, 0) total
			FROM 	
					(select category_no, nvl(sum(term_cash), 0) + nvl(sum(term_card), 0) total
			      	from accountbook_term
			     	where term_gubun='지출'
			     	and user_id = #{value}
			   		group by category_no) A, accountBook_category B 
			WHERE 
					A.category_no(+) = B.category_no
					and B.category_no &lt;= 10
		</select>
 	
 		<!--
 		 카테고리별 수입 금액 
 		 :카테고리 번호를 이용하여  카테고리 종류별로 카테고리 이름과 토탈비용 조회
 		-->
 		
 		<select id="getCategoryAndIncomeByCategoryNo" parameterType="string" resultType="hashmap" >
 		
 		SELECT 
 				B.category_name, nvl(total, 0) total
		FROM 	
				(select category_no, nvl(sum(term_cash), 0) + nvl(sum(term_card), 0) total
      			from accountbook_term
     			where term_gubun='수입'
     			and user_id = #{value}
   			    group by category_no) A, accountBook_category B 
		WHERE 
				A.category_no(+) = B.category_no
				and B.category_no >= 10
 		</select>
 	  
 	
 	<!-- 예산 추가 -->
 	<!-- 예산 조회 -->
 	
 	
 	
  </mapper>